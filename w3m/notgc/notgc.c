/*
Copyright 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include <gc.h>

static int gc_bucket_small[2049] = {
  0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32,
  32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 48, 48, 48, 48, 48, 48,
  48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 64, 64, 64, 64, 64, 64, 64, 64, 64,
  64, 64, 64, 64, 64, 64, 64, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80,
  80, 80, 80, 80, 96, 96, 96, 96, 96, 96, 96, 96, 96, 96,96, 96, 96, 96, 96,
  96, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112, 112,
  112, 112, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
  128, 128, 128, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144, 144,
  144, 144, 144, 144, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160,
  160, 160, 160, 160, 160, 176, 176, 176,176, 176, 176, 176, 176, 176, 176,
  176, 176, 176, 176, 176, 176, 192, 192, 192, 192, 192, 192, 192, 192, 192,
  192, 192, 192, 192, 192, 192, 192, 208, 208, 208, 208, 208, 208, 208, 208,
  208, 208, 208, 208, 208, 208, 208, 208, 224, 224, 224, 224, 224, 224, 224,
  224, 224, 224, 224, 224, 224, 224, 224, 224, 240, 240, 240, 240, 240, 240,
  240, 240, 240, 240, 240, 240, 240, 240, 240, 240, 256, 256, 256, 256, 256,
  256, 256, 256, 256, 256, 256, 256, 256, 256, 256, 256, 272, 272, 272, 272,
  272, 272, 272, 272, 272, 272, 272, 272, 272, 272, 272, 272, 288, 288, 288,
  288, 288, 288, 288, 288, 288, 288, 288, 288, 288, 288, 288, 288, 304, 304,
  304, 304, 304, 304, 304, 304, 304, 304, 304, 304, 304, 304, 304, 304, 320,
  320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320,
  336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336,
  336, 352, 352, 352, 352, 352, 352, 352, 352, 352, 352, 352, 352, 352, 352,
  352, 352, 368, 368, 368, 368, 368, 368, 368, 368, 368, 368, 368, 368, 368,
  368, 368, 368, 384, 384, 384, 384, 384, 384, 384, 384, 384, 384, 384, 384,
  384, 384, 384, 384, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448,
  448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448,
  448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448,
  448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448, 448,
  448, 448, 448, 448, 448, 448, 448, 448, 512, 512, 512, 512, 512, 512, 512,
  512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512,
  512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512,
  512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512,
  512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 512, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672,672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672, 672,
  672, 672, 672, 672, 672, 672, 672, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  1024, 1024, 1024, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344,1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344,
  1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 1344, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048,2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 2048,
  2048, 2064,
};

static
size_t bucketing(size_t size) {
  if (!getenv("SIMULATE_BUCKET"))
    return size;

  if (size < sizeof(gc_bucket_small) / sizeof(gc_bucket_small[0])) {
    return gc_bucket_small[size];
  }
  return (size + 16) / 16 * 16;
}

static
void* default_oom(size_t size) {
  abort();
}

static GC_oom_func oom_fn = default_oom;

struct Meta {
  size_t size;
  void *ptr;
};

static struct Meta *g_record;
static size_t g_count;
static size_t g_cap;

static
void* out_of_memory(size_t size) {
  oom_fn(size);
  return NULL;
}

static
struct Meta* find_allocate(void *p) {
  size_t i;
  for (i = 0; i < g_count; i++)
    if (g_record[i].ptr == p) {
      return g_record + i;
    }
  return NULL;
}

void GC_free(void *p) {
  size_t i;
  if (!p)
    return;
  for (i = 0; i < g_count; i++)
    if (g_record[i].ptr == p) {
      g_record[i] = g_record[--g_count];
      break;
    }
  free(p);
}

GC_warn_proc GC_CALL GC_get_warn_proc(void) {
  return NULL;
}

void GC_init(void) {
}

static
void allocate_meta(size_t size, void *ptr) {
  if (g_count == g_cap) {
    if (g_cap == 0)
      g_cap = 1000;
    else
      g_cap *= 2;
    g_record = realloc(g_record, sizeof(struct Meta) * g_cap);
    if (g_record == NULL) {
      out_of_memory(sizeof(struct Meta) * g_cap);
      abort();
    }
  }
  g_record[g_count].size = size;
  g_record[g_count].ptr = ptr;
  g_count++;
}

void * GC_malloc(size_t size_in_bytes) {
  void *p;
  if (size_in_bytes == 0)
    return NULL;
  //fprintf(stderr, "GC_malloc(%llu)\n", (unsigned long long) size_in_bytes);
  p = calloc(1, bucketing(size_in_bytes));

  if (!p)
    return out_of_memory(size_in_bytes);

  // need to keep track allocation size for later GC_realloc.
  allocate_meta(size_in_bytes, p);

  return p;
}

void * GC_malloc_atomic(size_t size_in_bytes) {
  void *p;
  if (size_in_bytes == 0)
    return NULL;
  //fprintf(stderr, "GC_malloc(%llu)\n", (unsigned long long) size_in_bytes);
  p = malloc(bucketing(size_in_bytes));

  if (!p)
    return out_of_memory(size_in_bytes);

  return p;
}

void * GC_realloc(void * old_object, size_t new_size_in_bytes) {
  struct Meta *meta;
  void *new_ptr;
  if (old_object == NULL)
    return GC_malloc(new_size_in_bytes);

  meta = find_allocate(old_object);
  if (!meta) {
    return realloc(old_object, bucketing(new_size_in_bytes));
  }

  if (new_size_in_bytes == 0) {
    GC_free(old_object);
    return NULL;
  }

  new_ptr = realloc(old_object, bucketing(new_size_in_bytes));
  if (new_ptr == NULL)
    return out_of_memory(new_size_in_bytes);

  if (meta->size < new_size_in_bytes)
    memset(new_ptr + bucketing(meta->size), 0, bucketing(new_size_in_bytes) - bucketing(meta->size));
  meta->ptr = new_ptr;
  meta->size = new_size_in_bytes;
  return new_ptr;
}

void GC_set_oom_fn(GC_oom_func func) {
  oom_fn = func;
}

void GC_set_warn_proc(GC_warn_proc p) {
}

